%!TEX root = ../thesis.tex
\chapter{Approximating fluid queues with the discontinuous Galerkin method\label{ch:galerkin}} 

In this chapter we introduce the discontinuous Galerkin (DG) method applied to fluid queues to approximate the operator-analytic expressions for fluid-fluid queues in \cite{bo2014}. 
\begin{center}
	\begin{minipage}{0.8\textwidth}
		\textit{Apart from Section~\ref{sec: other applications}, this chapter has been taken from Section~4 and 5 of \cite{blnos2022} with only minor changes, such as notation, so that this chapter is consistent with the rest of the thesis. I am a co-author of the paper \cite{blnos2022}. %The conceptualisation of \cite{blnos2022} was originally by Vikram Sunkara, Nigel Bean and Giang Nguyen, and the original coding was done by Vikram Sunkara. I made significant contributions to Section~3 of the paper, expressing the operator-theoretic expressions to use the same partition as the approximation scheme. I contributed Sections~4.4 and 5.1. I extended the numerical experiments in Section~6 to higher orders and made all the plots in Section~6. Appendix~A is also my original work. I did a significant proportion of the writing of the manuscript and addressed the reviewers comments and also developed code for the numerical experiments.
		}
	\end{minipage}
	\end{center}
% The DG method for B 
    % direct copy paste from the paper
% Problems with DG, non-neg/oscillations
    % solutions: filtering and limiting
% Approximating R: projection, interpolation, cell averages (eluding to QBD-RAP and unif method)
% Approximating Psi (and the limiting distribution, but this isnt really necessary)
    % constructing D
    % solving the matrix-Riccati equation, iteration/algorithm. 

% Appendix: the toy model. 
% Appendix: some properties of B?

% \section{Discontinuous Galerkin Approximation of the Generator of a Fluid Queue}
	% \label{sec:DG}
Discontinuous Galerkin (DG) methods can be used to approximate the solutions to systems of partial differential equations (PDEs). Here we describe how one can apply the DG method to approximate fluid queues and fluid-fluid queues. In finite-element methods we project the partial differential equations onto a set of piecewise polynomial functions. This projection leads to a new system of equations which represent a \textit{weak form} of the original system of PDEs. Next, we approximate the \textit{flux operator} which moves mass from one cell to another. This creates a system of ordinary differential equations which is known as a \emph{semi-discrete system} (discrete in the spatial variable but continuous in time). We can solve the semi-discrete system to approximate transient distributions of the fluid queue or, as we do in Section~\ref{sec:DGSFFM}, we can extract and manipulate an approximation to the generator of the fluid queue to approximate performance measures of fluid-fluid queues. Here we construct the DG approximation to the matrix of operators \(\mathbb B\) which we use later to construct a DG approximation to \(\mathbb D(s)\) then \(\mathbb\Psi(s)\), and ultimately the limiting distribution of a stochastic fluid-fluid queue. The DG method is convenient for approximating stochastic processes as it conserves the total probability of the system (as shown in Corollary~\ref{cor: googgy}).

\section{The partial differential equation}
We start by recalling the PDE (assuming the PDE exists) from which we will extract the approximation to the generator \(\mathbb B\). 

Let $f_i(x,t)$ be the joint density of an unbounded fluid queue $(\ddot X_t, \varphi_t)$ (assuming a density exists): 
	% 
	\begin{align*} 
	    f_i(x,t) = \cfrac{\partial}{\partial x} 	\mathbb{P}\left(X(t) \leq x, \varphi(t) = i\right),\quad i \in\calS,
	\end{align*} 
which satisfies the system of partial differential equations 
%
\begin{align*}
\cfrac{\partial}{\partial t} f_i(x,t)& = \sum_{j\in \mathcal{S}}  f_j(x,t)T_{ji} - c_i \cfrac{\partial}{\partial x} f_i(x,t), \quad i\in\mathcal S,
\end{align*}
% 
subject to suitable boundary conditions. In matrix form, 
\begin{align}
\cfrac{\partial}{\partial t} \boldsymbol f(x,t) &= \boldsymbol f(x,t)\bs T -  \cfrac{\partial}{\partial x}\boldsymbol f(x,t)\widehat{\bs C}\label{eqn:pde_density_matrix}, 
\end{align}
where \(\boldsymbol f(x,t) = \left(f_i(x,t)\right)_{i\in\mathcal S}\) is a row-vector. 
% This system of PDEs is closely related to the generator \(\mathbb B\); \(\boldsymbol \mu(t)\) satisfies the operator differential equation
% \begin{align*}
% 	\cfrac{\wrt}{\wrt t}\boldsymbol \mu(t)(\wrt x)  = \boldsymbol \mu(t)\mathbb B(\wrt x) = \boldsymbol f(x,t)\bs T\wrt x - \cfrac{\partial}{\partial x}\boldsymbol f(x,t)\bs C\wrt x,
% \end{align*}
% on the interior of the space \([0,\infty)\). Thus, by approximating the operator on the right-hand side of Equation~(\ref{eqn:pde_density_matrix}) we can approximate the infinitesimal operator \(\mathbb B\). The DG method does exactly this, by approximating the operator with a matrix.

\section{Cells, test functions, and weak formulation}
To begin with, consider an unbounded fluid queue with fluid level \(\{\ddot X_t,t\geq0\}\), \(\ddot X_t\in(-\infty,\infty)\). Later, we will use the approximation to the generator of the fluid queue to approximate performance measures of fluid-fluid queues, but for now, we can consider just the driving fluid queue. We will eventually truncate the state space, \(\ddot X_t\in(-\infty,\infty)\), so that we have a finite dimensional approximation; however, this requires a discussion of boundary conditions which we save for later. Let \(\mathcal D_{k,i} = [y_k,y_{k+1}),\, k\in\mathbb Z\) for \(i\in\calS_+\cup\calS_0\) and \(\mathcal D_{k,i} = (y_k,y_{k+1}],\, k\in\mathbb Z\) for \(i\in\calS_-\), \(y_k<y_{k+1}\), partition the domain \((-\infty,\infty)\). We call the \(\calD_{k,i}\) \textit{cells} and define \(\Delta_k=y_{k+1}-y_k\). 

For each \(k\in \mathbb Z\) we choose \(p_k\) linearly independent functions \(\{\phi^r_k\}_{r=1}^{p_k}\), supported on \(\calD_{k,i}\) (i.e.~\(\phi^r_k(x)=0\) for \(x\notin\calD_{k,i}\)) for all \(i\in\calS\), to form a basis for the space \(U_k\), in which we formulate the approximation. Here, as is standard in DG methods \citep{nodalDGBook}, we take \(\{\phi^r_k\}_{r=1}^{p_k}\) to be a basis for the space of polynomials of degree \(p_k-1\). For the sake of illustration, the reader may think of \(\{\phi^r_k\}_{r=1}^{p_k}\) as the Lagrange polynomials, but any polynomial basis can be used. On each cell \(\mathcal D_{k,i}\) we approximate 
\[f_i(x,t)\approx u_{k,i}(x,t)=\sum\limits_{r=1}^{p_k}a_{k,i}^r(t)\phi^r_k(x),\] 
where \(a_{k,i}^r(t)\) are yet-to-be-determined time-dependent coefficients. We refer to \(u_{k,i}\) as the \textit{local} approximation on cell \(k\), while the \textit{global} approximation is given by \(\sum\limits_{k\in\mathbb Z}u_{k,i}\) on the whole domain. %The whole approximation space is \(\bigoplus\limits_{k\in\mathbb Z} W_k\), the direct sum of the spaces \(W_k\), \(k\in\mathbb Z\).

Let \(\mathcal N_k = \left\{1,\dots,p_k\right\},\, k \in \mathbb Z\). For \(k\in\mathbb Z,\) define \textit{local} row-vectors 
\[\boldsymbol \phi_k(x) = (\phi^r_k(x))_{r\in\mathcal N_k}, \quad \boldsymbol a_{k,i}(t) = (a_{k,i}^r(t))_{r\in\mathcal N_k},\,i\in\mathcal S.\]
%Also define \textit{global} row-vectors 
%\[\boldsymbol \phi(x) = (\boldsymbol\phi^k(x))_{k\in\{1,...,K\}},\quad \boldsymbol a_i(x) = (\boldsymbol a_{k,i}(x))_{k\in\{1,...,K\}},\,i\in\mathcal S.\]
Note that we will always use the letter \(r\) to index the basis function within each cell.

The DG method proceeds by first considering the \textit{weak-formulation} of the PDE, which is constructed from the \textit{strong-form} of the PDE, Equation~(\ref{eqn:pde_density_matrix}). In general, to construct the weak-form we need a set of test functions, say \(U\). Now, take the strong form of the PDE, multiply it by some test function \(\psi\in U\), integrate with respect to \(x\), and apply integration by parts to get 
\begin{align}
\begin{multlined}[t]
	\int_{x\in\mathbb R}\cfrac{\partial}{\partial t} f_j(x,t)\psi(x)\wrt x = \int_{x\in\mathbb R} \sum_{i\in\calS}f_i(x,t)T_{ij}\psi(x)\wrt x 
	%
	+  \int_{x\in\mathbb R} f_j(x,t)c_j\cfrac{\wrt}{\wrt x}\psi(x)\wrt x \\{}- [ f_j(x,t)c_j\psi(x)]_{x=-\infty}^{x=\infty}, \end{multlined}\label{eqn:weak form}
\end{align}
for \(j\in\calS\). It is convenient to choose \(U\) such that \(\psi(-\infty)=\psi(\infty)=0\), in which case the last term on the right is zero. %Requiring (\ref{eqn:weak form}) to hold for every \(\psi\in U\) gives the weak-formulation of the PDE. Solutions to (\ref{eqn:weak form}) are known as \textit{weak} solutions and generalise the concept of a solution of the PDE. %For example, this may allow discontinuities with respect to \(x\) in the solution -- something which is ill-defined for the strong form.

For the problem at hand, we take the set of test functions to be \(U = \bigoplus\limits_{k\in\mathbb Z} U_k\), the direct sum of \(U_k\), where \(U_k\) is the domain of the approximation on the interval \(\calD_k\). Further, we use the same basis functions for the test-function space and the approximation space. Proceeding as described above, for all \(j\in\mathcal S,\,r\in\mathcal N_k\), \(k\in\mathbb Z,\) the weak formulation is 
\begin{align*}
	\begin{multlined}[t]\int_{x=y_k}^{y_{k+1}}\cfrac{\partial}{\partial t} f_j(x,t)\phi^r_k(x)\wrt x = \int_{x=y_k}^{y_{k+1}}\sum_{i\in\calS}  f_i(x,t)T_{ij}\phi^r_k(x)\wrt x  
	%
	+  \int_{x=y_k}^{y_{k+1}} f_j(x,t)c_j\cfrac{\wrt}{\wrt x}\phi^r_k(x)\wrt x \\ {}- [f_j(x,t)c_j\phi^r_k(x)]_{x=y_k}^{x=y_{k+1}}, \end{multlined}
\end{align*}
since \(\phi^r_k\) is compactly supported on \(\calD_{k,j}\). Now, as any function \(g(x)\) can be decomposed as \(g(x) = g^{U}(x)+g^\perp(x)\) where \(g^{U}\in U\) and \(g^\perp \in U^\perp\), the orthogonal complement of \(U\). Since \(g^\perp\) is orthogonal to \(U\), \(\displaystyle\int_{x}g^\perp(x)\phi^r_k(x)\wrt x=0\) for \(r\in\mathcal N_k,\,k\in\mathbb Z\). Also, note that \(\cfrac{\wrt}{\wrt x}\phi^r_k(x)\in U\). Using this, we can write 
\begin{align*}
	\begin{multlined}[t]\int_{x=y_{k}}^{y_{k+1}}\cfrac{\partial}{\partial t} \left(f_j^U(x,t)+f_j^\perp(x,t)\right)\phi^r_k(x)\wrt x 
	= \int_{x=y_k}^{y_{k+1}}\sum_{i\in\calS} \left(f_i^U(x,t)+f_i^\perp(x,t)\right)T_{ij}\phi^r_k(x)\wrt x  
	%
	\\ {}
	+  \int_{x=y_k}^{y_{k+1}} \left(f_j^U(x,t)+f_j^\perp(x,t)\right)c_j\cfrac{\wrt}{\wrt x}\phi^r_k(x)\wrt x - [f_j(x,t)c_j\phi^r_k(x)]_{x=y_k}^{x=y_{k+1}}, \end{multlined}
\end{align*}
	which reduces to
\begin{align}
	\begin{multlined}[t]\int_{x=y_k}^{y_{k+1}}\cfrac{\partial}{\partial t} f_j^U(x,t)\phi^r_k(x)\wrt x = \int_{x=y_k}^{y_{k+1}}\sum_{i\in\calS} f_i^U(x,t)T_{ij}\phi^r_k(x)\wrt x  
	%
	\\{} + \int_{x=y_k}^{y_{k+1}} f_j^U(x,t)c_j\cfrac{\wrt}{\wrt x}\phi^r_k(x)\wrt x - [f_j(x,t)c_j\phi^r_k(x)]_{x=y_k}^{x=y_{k+1}}. \end{multlined} \label{eqn:hash}
\end{align}
Now, \(f_j^U(x,t)\in U\) so, on \(\mathcal D_{k,j}\), it can be expressed as \(u_{k,j}(x,t)=\boldsymbol a_{k,j}(t) \boldsymbol \phi_k(x)\tr{}\), where the prime denotes the transpose, which we now substitute into (\ref{eqn:hash})
%\begin{align*}
%	\begin{multlined}[t]\int_{x\in\calD_k}\cfrac{\wrt}{\wrt t} \boldsymbol a_{k,j}(t) \boldsymbol \phi^k(x)\tr{}\phi^r_k(x)\wrt x = \int_{x\in\calD_k}\sum_{i\in\calS} \boldsymbol a_{k,i}(t) \boldsymbol \phi^k(x)\tr{}T_{ij}\phi^r_k(x)\wrt x  
%	%
%	\\ {}+  \int_{x\in\calD_k}\boldsymbol a_{k,j}(t) \boldsymbol \phi^k(x)\tr{}c_j\cfrac{\wrt}{\wrt x}\phi^r_k(x)\wrt x - c_j[f_j(x,t)\phi^r_k(x)]_{x=y_k}^{x=y_{k+1}}.\end{multlined}
%\end{align*}
and repeat this for all test functions \(\phi^r_k(x)\), \(r=1,...,p_k\), to get the system of equations,
\begin{align}
	\begin{multlined}[t]\int_{x=y_k}^{y_{k+1}}\cfrac{\wrt}{\wrt t} \boldsymbol a_{k,j}(t) \boldsymbol \phi_k(x)\tr{}\boldsymbol \phi_k(x)\wrt x = \int_{x=y_k}^{y_{k+1}}\sum_{i\in\calS} \boldsymbol a_{k,i}(t) \boldsymbol \phi_k(x)\tr{}T_{ij}\boldsymbol\phi_k (x)\wrt x  
	%
	\\{}+  \int_{x=y_k}^{y_{k+1}}\boldsymbol a_{k,j}(t) \boldsymbol \phi_k(x)\tr{}c_j\cfrac{\wrt}{\wrt x}\boldsymbol\phi_k(x)\wrt x - c_j[f_j(x,t) \boldsymbol\phi_k(x)]_{x=y_k}^{x=y_{k+1}},\quad k\in\mathbb Z. \end{multlined} \label{eqn:DG system}
\end{align}

\section{Mass, stiffness, and flux matrices}\label{sec:llaaksksbnnn}
Recall, for \(k\in\mathbb Z\), we defined local \textit{mass} and \textit{stiffness} matrices \(\bs M_k\) and \(\bs G_k\) by 
\[\bs M_k = \int_{x\in\calD_k}\boldsymbol \phi_k(x)\tr{}\boldsymbol \phi_k(x)\wrt x,\quad \bs G_k = \int_{x\in\calD_k}\boldsymbol \phi_k(x)\tr{}\cfrac{\wrt}{\wrt x} \boldsymbol \phi_k(x)\wrt x.\]
%and global mass and stiffness matrices by
%\begin{align*}
%	M &= \left[\begin{array}{ccc} M_1 & & \\ & \ddots & \\ & & M_K \end{array}\right] = \int_{x\inb}\boldsymbol \phi(x)\tr{}\boldsymbol \phi(x)\wrt x,
%	\\G &= \left[\begin{array}{ccc} G_1 & & \\ & \ddots & \\ & & G_K \end{array}\right] = \int_{x\inb}\boldsymbol \phi(x)\tr{}\cfrac{\wrt}{\wrt x}\boldsymbol \phi(x)\wrt x,
%\end{align*}
We can write (\ref{eqn:DG system}) as 
\begin{align}
	&\cfrac{\wrt}{\wrt t} \boldsymbol a_{k,j}(t) \bs M_k = \sum_{i\in\calS} \boldsymbol a_{k,i}(t)\bs M_kT_{ij} 
	%
	+  c_j\boldsymbol a_{k,j}(t) \bs G_k - c_j[f_j(x,t)\boldsymbol\phi_k(x)]_{x=y_k}^{x=y_{k+1}}.\label{eqn:DG matrix}
\end{align}

It remains to approximate the \textit{flux}, \(f_j(x,t)\) at the cell edges \(y_k,\,k\in\mathbb Z\), so that we may evaluate the terms \([f_j(x,t)\phi^r_k(x)]_{x=y_k}^{x=y_{k+1}}\), \(r=1,...,p_k,\,k\in\mathbb Z\). %This is the key for DG -- it joins the local approximations on each cell into a global approximation on the whole domain of approximation. 
The flux is the instantaneous rate (with respect to time) at which density moves across the boundaries \(y_k,\,k\in\mathbb Z\). There are different choices for the numerical flux, and we refer the reader to \citep{c99,nodalDGBook}, and references therein, for some discussion of the topic. Here, we choose the \textit{upwind} scheme, which, as we shall see, closely resembles the flux terms from the generator \(\mathbb B\). The approximate flux, also known as the \textit{numerical flux}, is given by 
\[f^*_j(x,t) = \mathrm{sign}(c_j)\lim_{\varepsilon\to0^+}u_j(x-\varepsilon c_j,t),\]
at each \(x=y_k,\,k\in\mathbb Z\). 
Intuitively, the upwind flux takes the value of the density immediately on the upwind side of each \(y_k\). 

Denote by \(x^-\) and \(x^+\) the left and right limits at \(x\), respectively. Assume first \(c_j>0\), then 
\begin{align*}
	-c_j[f_j(x,t)\phi^r_k(x)]_{x=y_k}^{x=y_{k+1}} & \approx -c_j[f_j^*(x,t)\phi^r_k(x)]_{x=y_k}^{x=y_{k+1}}
	\\& = -c_jf_j^*(y_{k+1},t)\phi^r_k(y_{k+1}) + c_jf_j^*(y_{k},t)\phi^r_k(y_{k})
	\\& = -c_ju_j(y_{k+1}^-,t)\phi^r_k(y_{k+1}) + c_ju_j(y_{k}^-,t)\phi^r_k(y_{k})
	\\& = -c_ju_{k,j}(y_{k+1}^-,t)\phi^r_k(y_{k+1}) + c_ju_{k-1,j}(y_{k}^-,t)\phi^r_k(y_{k})
	\\& = -c_j\boldsymbol a_{k,j}(t)\boldsymbol \phi_k(y_{k+1}^-)\tr{}\phi^r_k(y_{k+1}) + c_j\boldsymbol a_{k-1,j}(t)\boldsymbol \phi_{k-1}(y_{k}^-)\tr{}\phi^r_k(y_{k}).
\end{align*}
In matrix form,  
\begin{align*}
	-c_j[f_j(x,t)\boldsymbol\phi_k(x)]_{x=y_k}^{x=y_{k+1}} & \approx -c_j[f_j^*(x,t)\boldsymbol\phi_k(x)]_{x=y_k}^{x=y_{k+1}}
	\\& = -c_j\boldsymbol a_{k,j}(t)\boldsymbol \phi_k(y_{k+1}^-)\tr{}\boldsymbol\phi_k(y_{k+1}) + c_j\boldsymbol a_{k-1,j}(t)\boldsymbol \phi_{k-1}(y_{k}^-)\tr{}\boldsymbol\phi_k(y_{k})
	\\& = c_j\boldsymbol a_{k,j}(t)F_j^{k,k}+c_j\boldsymbol a_{k-1,j}(t)F_j^{k-1,k},
\end{align*}
where, for \(j\in \calS\) with \(c_j>0\), we define \(\bs F_+^{k,k}=\bs F_j^{k,k} = -\boldsymbol \phi_k(y_{k+1}^-)\tr{}\boldsymbol\phi_k(y_{k+1}),\,k\in\mathbb Z\) and \(\bs F_j^{k-1,k} = \boldsymbol \phi_{k-1}(y_{k}^-)\tr{}\boldsymbol\phi_k(y_{k}),\,k\in\mathbb Z\).

Now proceed similarly for \(c_j<0\) to get the approximation 
\begin{align*}
	-c_j[f_j(x,t)\boldsymbol\phi_k(x)]_{x=y_k}^{x=y_{k+1}} & \approx -c_j[f_j^*(x,t)\boldsymbol\phi_k(x)]_{x=y_k}^{x=y_{k+1}}
	\\& = -c_j\boldsymbol a_{k+1,j}(t)\boldsymbol \phi_{k+1}(y_{k+1}^+)\tr{}\boldsymbol\phi_k(y_{k+1}) + c_j\boldsymbol a_{k,j}(t)\boldsymbol \phi_{k}(y_{k}^+)\tr{}\boldsymbol\phi_k(y_{k})
	\\& = c_j\boldsymbol a_{k+1,j}(t)\bs F_j^{k+1,k}+c_j\boldsymbol a_{k,j}(t)\bs F_j^{k,k},
\end{align*}
where, for \(j\in \calS\) with \(c_j<0\), we define \(\bs F_j^{k+1,k} = -\boldsymbol \phi_{k+1}(y_{k+1}^+)\tr{}\boldsymbol\phi_k(y_{k+1}),\,k\in\mathbb Z,\) and \(\bs F_-^{k,k}=\bs F_j^{k,k} = \boldsymbol \phi_{k}(y_{k}^+)\tr{}\boldsymbol\phi_k(y_{k}),\,k\in\mathbb Z\).

The matrices \(\bs F_j^{k-1,k},\,\bs F_j^{k,k},\) and \(\bs F_j^{k+1,k}\) are the local flux matrices. For convenience, we also define the matrices \(\bs F_j^{k,k+1}=0\) for \(j\in\calS_-\) and \(\bs F_j^{k,k-1}=0\) for \(j\in\calS_+\), \(k\in\mathbb Z\).


% from which we can assemble the global flux matrices
%\begin{align*}
%	F_j &= \left[\begin{array}{cccccc}
%		F_j^{1,1} & F_j^{1,2} & & & & \\
%		 & F_j^{2,2} & F_j^{2,3} & & & \\
%		& & \ddots & \ddots & & \\
%		& & & \ddots & \ddots & \\
%		& & & & F_j^{K-1,K-1} & F_j^{K-1,K} \\
%		& & & & & F_j^{K,K}
%	\end{array}\right],\quad c_j\geq0,
%	%
%	\\F_j &= \left[\begin{array}{cccccc}
%		F_j^{1,1} & & & & & \\
%		F_j^{2,1} & F_j^{2,2} & & & & \\
%		& \ddots & \ddots & & & \\
%		& & \ddots & \ddots & & \\
%		& & & F_j^{K-1,K-2} & F_j^{K-1,K} & \\
%		& & & & F_j^{K-1,K} & F_j^{K,K}
%	\end{array}\right],\quad c_j<0.
%\end{align*}
%
%We can now write 
%\begin{align*}
%	&\cfrac{\wrt}{\wrt t} \boldsymbol a_j(t) M = \sum_{i\in\calS} \boldsymbol a_j(t)MT_{ij} 
%	%
%	+  c_j\boldsymbol a_j(t) (G + F_j).
%\end{align*}
%
%Defining \(\boldsymbol a(t) = (\boldsymbol a_j(t))_{i\in\calS}\), then 
%\begin{align}\label{eqn:DG ODE}
%	&\cfrac{\wrt}{\wrt t} \boldsymbol a(t)(I_{N_\calS}\otimes M) = \boldsymbol a(t){  B,}
%\end{align}
%where 
%\[{  B} = \left[(T\otimes M) +
%	\left[\begin{array}{ccc}
%		c_1(G+F_1) & &  \\
%		& \ddots & \\
%		& & c_{N_\calS}(G+F_{N_\calS})\\
%	\end{array}\right] \right],\]
%\(\otimes\) is the kronecker product and \(I_{N_\calS}\) is the \(N_\calS\times N_\calS\) identity matrix.

%So far, this DG approximation has been constructed according to the lexicographic ordering of \(\calS\times\{1,...,K\}\). A reordering of this construction according to the lexicographic ordering of \(\{1,...,K\}\times\calS\) helps elucidate the connection with the partitioned operator \(\mathbb B\) and eases notation slightly for the next discussion on boundary conditions. 

%Also define \textit{global} row-vectors 
%\[\boldsymbol \phi(x) = (\boldsymbol\phi^k(x))_{k\in\{1,...,K\}},\quad \boldsymbol a_j(x) = (\boldsymbol a_{k,i}(x))_{k\in\{1,...,K\}},\,i\in\mathcal S.\]

To write this out as a \textit{global} system, define the row-vectors 
\[\boldsymbol a_k(t) = (\boldsymbol a_{k,i}(t))_{i\in\mathcal S},\quad \boldsymbol a(t) = (\boldsymbol a_k(t))_{k\in\mathbb Z},\]
and the doubly-infinite block-tridiagonal matrix 
\begin{align*}
% \ddot{\bs M} &= \left[\begin{array}{ccc}\ddots&&\\&\bs I_{N_\calS}\otimes \bs M_k&\\&&\ddots\end{array}\right],
% \intertext{where \(N_\calS=|\calS|\), \(\otimes\) is the Kronecker product, and the block-tridiagonal matrix}
\ddot{\bs B} &= \left[\begin{array}{ccccc}
	\ddots & \ddots & \ddots & & \\
	& \ddot{\bs B}^{k,k-1} & \ddot{\bs B}^{k,k} & \ddot{\bs B}^{k,k+1} & \\
	& & \ddots & \ddots & \ddots 
\end{array}\right],
\end{align*}
where, for \(k\in\mathbb Z\), 
\begin{align*}
    \ddot{{\bs B}}^{kk}&=\left[\begin{array}{ccc}T_{11}\bs I + c_1(\bs F_1^{kk}+\bs G_k)\bs M_k^{-1} & T_{12}\bs I & T_{1N}\bs I  \\ T_{21}\bs I & & \\ \vdots &\ddots & \vdots \\ & &   T_{N-1,N}\bs I \\  T_{N1}\bs I &  T_{N,N-1}\bs I & T_{N,N}\bs I +c_{N}(\bs F_{N}^{kk}+\bs G_k)\bs M_k^{-1}\end{array}\right],\\
	\ddot{{\bs B}}^{k,k+1}&=\left[\begin{array}{ccc}c_1\bs F_1^{k,k+1}\bs M_{k+1}^{-1}&  & \\  &\ddots & \\  &  &c_{N}\bs F_{N}^{k,k+1}\bs M_{k+1}^{-1} \end{array}\right],\\
	\ddot{{\bs B}}^{k,k-1}&=\left[\begin{array}{ccc}c_1\bs F_1^{k,k-1}\bs M_{k-1}^{-1}&  & \\  &\ddots &  \\  &  &c_{N}\bs F_{N}^{k,k-1}\bs M_{k-1}^{-1} \end{array}\right].
\end{align*} 
The global system of equations is 
\begin{align}\label{eqn:DG ODE}
	&\cfrac{\wrt}{\wrt t} \boldsymbol a(t) = \boldsymbol a(t){\ddot{{\bs B}}}.
\end{align}

\section{Boundary conditions}\label{subsec: boundary DG}
To enable computation, the numerical approximation has to take place on a finite interval, which means we must consider a bounded domain and specify boundary conditions. Recall that we wish to impose lower and upper boundaries at \(0\) and \(b\), respectively. On the interior of the space, the PDE (\ref{eqn:pde_density_matrix}) (assuming it exists) still describes the evolution of the distribution of the fluid queue. Regarding the approximation, the constructions above can still be used to approximate the evolution of the fluid queue on the interior of the space. The imposition of boundary conditions amounts to truncating the operator \(\ddot{\bs B}\), adding boundary elements to the system and describing how mass moves between the boundary and the elements adjacent to the boundary.  %In the numerics chapter, Chapter~\ref{sec: numerics}, we wish to approximate a fluid-fluid queue where the first fluid level, \(\dot X_t\), is bounded below at 0, only: in that case the first step in the approximation scheme is to approximate \(\dot X_t\) by \( X_t\). The truncation of \(X_t\) to \(\overline X_t\) will result in an artificial point mass at the upper bound, which we have to address properly. It is important to choose an \(b\) sufficiently large to control the error induced by the artificial upper bound, however, with larger \(b\) there comes increased computational burden. 

Let $[0,b]$ be the domain of the approximation, where $b < \infty$. We partition the space $[0,b]$ into \(\mathcal D_{-1}=\{0\},\) \(\mathcal D_{K+1}=\{b\},\) and \(K\) non-trivial intervals, \(\calD_{k,i}=[y_k,y_{k+1})\setminus \{0\},\,i\in\calS_+\cup\calS_0,\calD_{k,i}=(y_k,y_{k+1}]\setminus \{0\},\,i\in\calS_-,\, y_k<y_{k+1},\, k\in\mathcal K^\circ\), \(y_0=0,\,y_{K+1}=b\) and define \(\Delta_k = y_{k+1}-y_k\). 

For states with \(c_i\leq 0\), there is the possibility of point mass accumulating at the boundary at~\(0\). Denote these point masses by \(q_{{-1},i}(t)\) for \(i\in\mathcal S_{-1}\). For states with \(c_i>0\) there is no possibility of a point mass at \(0\). Similarly, for \(c_i\geq 0\) there is the possibility of a point mass at \(b\). Denote these point masses by \(q_{{K+1},i}(t)\), for \(i\in\mathcal S_{K+1}\). For states with \(c_i<0\) there is no possibility of a point mass at \(b\). Let \(\bs q_{-1}(t)=(q_{{-1},i}(t))_{i\in\calS_{-1}}\) and \(\bs q_{K+1}(t) = (q_{{K+1},i}(t))_{i\in\calS_{K+1}}\) and \(\bs f_m(x,t) = (f_i(x,t))_{i\in\calS_m}\), \(m\in\{+,-,0\}\). 

Let us first consider the boundary at \( X_t=0\). The boundary conditions that describe the evolution of probability/density of a stochastic fluid queue with a boundary at \(0\) are;
\begin{align}\label{eqn:BC1}
\cfrac{\wrt}{\wrt t}\bs q_{-1}(t) &= \bs q_{-1}(t) \bs T_{{-1},{-1}} + \boldsymbol f_-(0,t)\bs C_-\bs P_{-,{-1}},
\\\label{eqn:BC2}
\bs f_-(0^+,t)\bs C_-\bs P_{-,+} + \bs q_{-1}(t)\bs T_{{-1},+}&=\bs f_+(0,t)\bs C_+,
\end{align}
where \(\bs P_{-,+} = \left[\widecheck p_{ij}\right]_{i\in\calS_-,j\in\calS_{+}}\), \(\bs P_{-,{-1}} = \left[\widecheck p_{ij}\right]_{i\in\calS_-,j\in\calS_{-1}}\) and \(\widecheck p_{ij}\) is the probability of instantaneous transition of the phase process from Phase \(i\) to Phase \(j\) upon the process hitting the lower boundary. Equation~(\ref{eqn:BC1}) states that point mass moves between phases according to the sub-generator matrix \(\bs T_{{-1},{-1}}\), and that the flux of probability density into the point masses is \(\boldsymbol f_-(0,t)\bs P_{-,{-1}}\bs C_{-1}\). Substituting the DG approximation for \(\boldsymbol f_-(0,t)\) into (\ref{eqn:BC1}) gives, for \(j\in\calS_{-1}\), 
\begin{equation*}\label{eqn:DGBC1}
\cfrac{\wrt}{\wrt t} q_{{-1},j}(t) = \sum_{i\in\calS_{-1}} q_{{-1},i}(t) T_{i j} - \sum_{i\in\calS_-}\boldsymbol a_{0,i}(t)\boldsymbol \phi_0(0^+)\tr{}\widecheck p_{ij} c_i.
\end{equation*}
Equation~(\ref{eqn:BC2}) describes the reflection of process at \(0\), plus the flux of probability mass to density upon a transition from a phase in \(\calS_{-1}\) to a phase in \(\calS_+\). Thus, the flux into the left-hand edge of \(\calD_{0,j}\) in phase \(j\in\calS_+\) is, \(\sum\limits_{i\in\calS_{-1}} q_{{-1},i}(t)T_{ij}\). Therefore, we can now evaluate 
\begin{align*}
	&-c_j[f_j(x,t)\boldsymbol\phi_0(x)]_{x=0}^{x=y_{0}} 
	\\& =  -c_jf_j(y_0^-,t)\boldsymbol\phi_0(y_0)+c_jf_j(0^+,t)\boldsymbol\phi_0(0) - \sum_{i\in\calS_-}c_if_i(0^+,t)\widecheck p_{ij}\bs \phi_0(0)
	\\& \approx -c_j f_j^*(y_0,t)\boldsymbol\phi_0(y_0)+\sum_{i\in\calS_{-1}}q_{{-1},i}(t)T_{ij}\boldsymbol\phi_0(0) - \sum_{i\in\calS_-}c_i\widecheck p_{ij}\bs a_{0,i}(t)\bs \phi_0(0)\tr{}\bs \phi_0(0)
	\\& = c_j\boldsymbol a_{0,j}(t)\bs F_j^{0,0}+\sum_{i\in\calS_{-1}}q_{{-1},i}(t)T_{ij}\boldsymbol\phi_0(0) - \sum_{i\in\calS_-}c_i\widecheck p_{ij}\bs a_{0,i}(t)\bs F_j^{0,0},
\end{align*}
for \(j \in \calS_+\). 

Thus, the DG approximation of the flux into point masses \(q_{{-1},j}(t)\) is \[-\sum_{i\in\calS_-}\boldsymbol a_{0,i}(t)\boldsymbol \phi_0(0)\tr{} p_{ij}^{-1} c_i,\,j\in\calS_-,\] the rate of transition of point mass within \(\bs q_{{-1}}(t)\) is \(\bs T_{{-1},{-1}}\), the DG approximation of the transition of point mass to density is \(\sum\limits_{i\in\calS_{-1}}q_{{-1},i}(t)T_{ij}\boldsymbol\phi_0(0),\,j\in\calS_+\), and the DG approximation to density reflected at the lower boundary is \(\sum_{i\in\calS_-}c_i\widecheck p_{ij}\bs a_{0,i}(t)\bs F_j^{0,0}\). 

Similarly, for the upper boundary at \(b\) the boundary conditions are 
\begin{align*}
\cfrac{\wrt}{\wrt t}\bs q_{K+1}(t) &= \bs q_{K+1}(t) T_{{K+1}, {K+1}} + \boldsymbol f_+(b,t)\bs C_+\bs P_{+,{K+1}},\\
\bs f_+(b^-,t)\bs C_+\bs P_{+,-} + \bs q_{K+1}(t)T_{{K+1}-}&=\bs f_-(b,t)\bs C_-,
\end{align*}
where \(\bs P_{+,-} = \left[\widehat p_{ij}\right]_{i\in\calS_+,j\in\calS_{-}}\), \(\bs P_{+,K+1} = \left[\widehat p_{ij} \right]_{i\in\calS_+,j\in\calS_{K+1}}\) and \(\widehat p_{ij} \) is the probability of instantaneous transition of the phase process from Phase \(i\) to Phase \(j\) upon the process hitting the lower boundary. Using the same arguments as above, 
\begin{align*}
\cfrac{\wrt}{\wrt t} q_{{K+1},j}(t) &= \sum_{i\in\calS_{K+1}}q_{{K+1},i}(t) T_{ij} + \sum_{i\in\calS_+}\boldsymbol a_{K,i}(t)\boldsymbol \phi_K(b)\tr{}\widehat p_{ij} c_i,
\\-c_j[f_j(x,t)\boldsymbol\phi_K(x)]_{x=y_K}^{x=b} & \approx c_j\boldsymbol a_{K,j}(t)\bs F_j^{K,K}+\sum_{i\in\calS_{K+1}}q_{{K+1},i}(t)T_{ij}\boldsymbol\phi_K(b) 
\\&\quad{} - \sum_{i\in\calS_+}c_i\widehat p_{ij} \bs a_{0,i}(t)\bs F_j^{0,0}
\end{align*}
for \(j\in\calS_-\). 

Thus, the DG approximation of the flux into the point mass \(q_{{K+1},j}(t)\) is 
\[\sum_{i\in\calS_+}\boldsymbol a_{K,i}(t)\boldsymbol \phi_K(0)\tr{} \widehat p_{ij} c_i,\]
\(j\in\calS_+\), the rate of transition of point mass within \(\bs q_{{K+1}}(t)\) is \(\bs T_{{K+1},{K+1}}\), the DG approximation of the transition of point mass to density is \(\sum\limits_{i\in\calS_{K+1}}q_{{K+1},i}(t)T_{ij}\boldsymbol\phi_K(b)\), \(j\in\calS_-\) and the approximation to reflection of density at the upper boundary is \(- \sum_{i\in\calS_+}c_i\widehat p_{ij} \bs a_{0,i}(t)\bs F_j^{0,0}\). 

To include the behaviour in the DG generator we truncate the doubly-infinite matrix \(\ddot{{\bs B}}\) at \(k=0\) and \(k=K\), then append \(|\mathcal S_{-1}|\) rows and columns to the top and left, and \(|\mathcal S_{K+1}|\) rows and columns to the bottom and right. These represent the point masses \(\bs q_{-1}(t)\) and \(\bs q_{K+1}(t)\), respectively. Given the discussion above, the truncated matrix is
\[{{\bs B}} = \left[\begin{array}{llllll}
	\bs T_{{-1},{-1}}& {{\bs B}}^{{-1},0} & & & & \\
	{{\bs B}}^{0,{-1}} & {{\bs B}}^{0,0} & {{\bs B}}^{0,1} & & & \\
	& {{\bs B}}^{1,0} & {{\bs B}}^{1,1} & {{\bs B}}^{1,2} & & \\
	& & \ddots & \ddots & \ddots & \\
	& & {{\bs B}}^{K-1,K-2} &{{\bs B}}^{K-1,K-1} & {{\bs B}}^{K-1,K} & \\
	& & &{{\bs B}}^{K,K-1} & {{\bs B}}^{K,K} & {{\bs B}}^{K,{K+1}} \\
	& & & & {{\bs B}}^{{K+1}, K} & \bs T_{{K+1},{K+1}}
\end{array}\right],\]
where 
\begin{align*}
	{{\bs B}}^{k,\ell} &= \ddot{{\bs B}}^{k,\ell}, \mbox{ for \(k\in\mathcal K^\circ\), \(\ell\in\{k-1,k,k+1\}\), \(k=\ell,\, k,\ell\notin \{0,K\}\),}
	\\ \bs B^{0,0} &= \ddot{\bs B}^{0,0} - \left[c_i\widecheck p_{ij}1(c_i<0, c_j>0)\right]_{i\in\calS,j\in\calS}\otimes \bs F_-^{0,0},
	\\ \bs B^{K,K} &= \ddot{\bs B}^{K,K} + \left[c_i\widecheck p_{ij} 1(c_i>0, c_j<0)\right]_{i\in\calS,j\in\calS}\otimes \bs F_+^{0,0}, 
	\\ {{\bs B}}^{{-1},0} &= \bs T_{{-1},+}\otimes \boldsymbol\phi^0(0), 
	\\ {{\bs B}}^{0,{-1}} &=-\left[c_i \widecheck p_{ij}  1{(c_i<0)}\right]_{i\in\calS,j\in\calS_{{-1}}} \otimes \boldsymbol \phi^0(0)\tr{}, 
	\\ {{\bs B}}^{{K+1}, K} &= \bs T_{{K+1},-}\otimes \boldsymbol\phi^K(b),
	\\ {{\bs B}}^{K,{K+1}} &= \left[c_i\widehat p_{ij}  1{(c_i>0)}\right]_{i\in\calS,j\in\calS_{K+1}} \otimes \boldsymbol \phi^K(b)\tr{},
\end{align*} 
and \(\otimes\) is the Kronecker product. 

For future reference, we also define the matrices \({{\bs B}}^{k,\ell}_{ij}\) for \(k\in\{2,\dots,K-1\}\), \(\ell\in\{k-1,k\},\) \(i,j\in\calS\), by
\begin{align*}
	{{\bs B}}^{k,k}_{ij} &= \begin{cases}T_{ij}\bs I_{p_k} + c_i(\bs F_i^{k,k}+\bs G_k)\bs M_k^{-1} & i=j,\\T_{ij} \bs I_{p_k}& i\neq j,\end{cases}
\\	{{\bs B}}^{k,\ell}_{ij} &= \begin{cases}c_i\bs F_i^{k,\ell}\bs M_\ell^{-1} & i=j,\\\bs 0 & i\neq j,\end{cases}\quad \ell \in \{k-1,k\}
\end{align*}
and
\begin{align*}
	{{\bs B}}^{0,0}_{ij} &= \begin{cases}T_{ij}\bs I_{p_k} + c_i(\bs F_i^{0,0}+\bs G_0)\bs M_0^{-1} & i=j,\\T_{ij}\bs I_{p_k} - 1(c_i<0,c_j>0)c_i\widecheck p_{ij} \bs F_i^{0,0}\bs M_0^{-1} & i\neq j,\end{cases}
\\	{{\bs B}}^{K,K}_{ij} &= \begin{cases}T_{ij}\bs I_{p_k} + c_i(\bs F_i^{K,K}+\bs G_K)\bs M_K^{-1} & i=j,\\T_{ij}\bs I_{p_K} + 1(c_i>0,c_j<0)c_i\widehat p_{ij} \bs F_i^{K,K}\bs M_K^{-1} & i\neq j.\end{cases}
\end{align*}

After the addition of the boundary conditions, the system of ODEs (\ref{eqn:DG ODE}) can now be written as 
\begin{align}\label{eqn: DG ODE w BCs}
	\cfrac{\wrt}{\wrt t} \vligne{\boldsymbol q_{{-1}}(t) & {\boldsymbol a}(t) & \boldsymbol q_{K+1}(t)} 
	% 
	= \vligne{\boldsymbol q_{{-1}}(t) & {\boldsymbol a}(t) & \boldsymbol q_{K+1}(t)} \bs B.
\end{align}

Approximations \( \bs B^{mn}_{ij}\), \( \bs B_{ij}\), and \( \bs B^{mn}\) to \(\mathbb B^{mn}_{ij}\), \(\mathbb B_{ij}\), and \(\mathbb B^{mn}\), \(i,j\in\calS,\,m,n\in\{+,-,0\}\), are constructed from the block-matrices \({  \bs B}^{k\ell}_{ij}\), \(i,j\in\calS\), \(k,\ell\in\mathcal K\), as
\begin{align*}
	{  \bs B}_{ij}^{m n} &= \left[{  \bs B}_{ij}^{k \ell}\right]_{k\in\mathcal K_i^m,\ell\in\mathcal K_j^n},\quad i,j\in\calS,\,m,n\in\{+,-,0\},
%\intertext{an approximation \({  B}_{ij}\) to \(\mathbb B_{ij}\), \({i,j\in\calS},\) is}
\\	{  \bs B}_{ij} &= \left[{  \bs B}_{ij}^{k\ell}\right]_{k,\ell\in\mathcal K},\,{i,j\in\calS},
%\intertext{and an approximation \({  B}^{mn}\) to \(\mathbb B^{mn}\), \(m,n\in\{+,-,0\}\) is}
\\	{  \bs B}^{m n} &= \left[\left[{  \bs B}_{ij}^{k\ell}\right]_{i\in\calS_k^m,j\in\calS_\ell^n}\right]_{k\in\mathcal K^m,\ell\in\mathcal K^n},\,m,n\in\{+,-,0\}.
\end{align*}
% where \(\bs B = \widehat{{\bs B}}\widehat{\bs M}^{-1}\) and \(\widehat{\bs M} = \left[\begin{array}{ccccc}
% 	\bs I_{|\calS_{-1}|} & & & & \\
% 	& \bs I_{p_S}\otimes \bs M_1 & & & \\
% 	& & \ddots & & \\
% 	& & & \bs I_{p_S}\otimes \bs M_K & \\
% 	& & & & \bs I_{|\calS_{K+1}|}
% \end{array}\right]\), that is, 
% \[\bs B = \left[\begin{array}{llllll}
% 	\bs T_{{-1},{-1}}& \widehat{{\bs B}}^{{-1}1}\bs M_1^{-1} & & & & \\
% 	\widehat{{\bs B}}^{1{-1}} & \ddot{{\bs B}}^{11}\bs M_1^{-1} & \ddot{{\bs B}}^{12}\bs M_2^{-1} & & & \\
% 	& \ddot{{\bs B}}^{21}\bs M_1^{-1} & \ddot{{\bs B}}^{22}\bs M_2^{-1} & \ddot{{\bs B}}^{23}\bs M_3^{-1} & & \\
% 	& & \ddots & \ddots & \ddots & \\
% 	& & \ddot{{\bs B}}^{K-1,K-2}\bs M_{K-2}^{-1} &\ddot{{\bs B}}^{K-1,K-1}\bs M_{K-1}^{-1} & \ddot{{\bs B}}^{K-1,K}\bs M_{K}^{-1} & \\
% 	& & &\ddot{{\bs B}}^{K,K-1}\bs M_{K-1}^{-1} & \ddot{{\bs B}}^{K,K}\bs M_{K}^{-1} & \widehat{{\bs B}}^{K,{K+1}} \\
% 	& & & & \widehat{{\bs B}}^{{K+1}, K}\bs M_{K}^{-1} & \bs T_{{K+1},{K+1}}
% \end{array}\right].\]

% Regarding our notational convention, we use regular mathematics fonts to represent DG approximations to operators, i.e.~\(\bs B\) is a DG approximation to \(\mathbb B\) and \(\bs \Psi\) is an approximation to \(\mathbb \Psi\). 

We prove the following result in Appendix~\ref{sec:properties}.
%This transformation is not strictly necessary and all the following calculations can be done with either form, as long as week keep a consistent interpretation of the DG generator and related coefficients. However, it is convenient to prove properties of the generator.
\begin{cor} \label{cor: googgy}
	The approximate generator \( \bs B\) conserves probability. That is, for all \(t\geq 0\),
	\begin{align*}
	\begin{multlined}[t]\sum_{i\in\calS_{-1}}q_{{-1},i}(t)+\sum_{i\in\calS_{K+1}}q_{{K+1},i}(t)+\sum_{i\in\calS} \int_{x\in[0,b]}u_i(x,t)\wrt x 
	%
	\\= \sum_{i\in\calS_{-1}}q_{{-1},i}(0)+\sum_{i\in\calS_{K+1}}q_{{K+1},i}(0)+\sum_{i\in\calS} \int_{x\in[0,b]}u_i(x,0)\wrt x.\end{multlined}
	\end{align*}
\end{cor}


\section{Application to a fluid-fluid queue}\label{sec:DGSFFM}
Given our approximation \(\bs B\) to the generator \(\mathbb B\) we now follow the recipe from \cite{bo2014}, replacing the actual generator \(\mathbb B\) with its approximation \({  \bs B}\), to construct approximations, \(\bs \pi\) and \(\bs p\), to the limiting operators, \(\bbpi\) and \(\mathbb p\).

It may be convenient to think of our approximations in terms of approximations of kernels. Recall that the operators in \citep{bo2014} can be thought of in terms of kernels. That is, for some function \(\bs g = (g_i(x))_{i\in\calS}\), we can write \(\bs \mu \mathbb B \boldsymbol g\tr{} = \displaystyle \sum\limits_{k,\ell\in\mathcal K}\sum\limits_{i,j\in\calS} \displaystyle \int_{x,y}\wrt \mu_i(x) \mathbb B_{ij}^{k\ell}(x,\wrt y)g_j(y)\) where \(\mathbb B_{ij}^{k\ell}(x,\wrt y)\) is the kernel of the operator \(\mathbb B_{ij}^{k\ell}\). 

Let \(\boldsymbol a_{-1}(t)=\boldsymbol q_{-1}(t)\) and \(\boldsymbol a_{K+1}(t)=\boldsymbol q_{K+1}(t)\), and define basis functions \(\bs\phi_{-1}(x) = \phi_{-1}^1(x) = \delta(x)\) and \(\bs\phi_{K+1}(x) = \phi_{K+1}^1(x) = \delta(x-b)\), where \(\delta\) is the Dirac delta, \(p_{-1} = p_{K+1} = 1\), and \(\mathcal N_{-1} = \mathcal N_{K+1} = \{1\}\). Also define \({\bs M}_{-1}=\bs I_{|\calS_{-1}|}\), \({\bs M}_{K+1}=\bs I_{|\calS_{K+1}|}\), the block-diagonal matrix \(\bs M=\mathrm{diag}(\bs M_k,k\in\mathcal K)\), and row-vectors 
\[\boldsymbol \phi(x) = (\bs\phi_k(x))_{k\in\mathcal K}, \quad \boldsymbol a_i(t) = (\bs a_{k,i}(t))_{k\in\mathcal K},\,i\in\calS.\]

To pose the approximation \(\bs B\) in kernel form let \(\boldsymbol a_i \boldsymbol \phi(x)\tr{}\in U,\,i\in\calS\) be the initial density of the process, and \(\boldsymbol \phi(x)\bs b_i\tr{}\in U,\,i\in\calS\) be a test function. Observe that, from our DG construction earlier and the definition of \({\bs M}\), 
\[\sum_{i,j\in\calS}\int_{x,y\in[0,b]} \boldsymbol a_i \boldsymbol \phi(x)\tr{} \boldsymbol \phi (x) \wrt x {\bs M}^{-1}{  \bs B}_{ij} \bs \phi(y)\tr{} \bs \phi(y)\bs b_j \wrt y= \sum_{i,j\in\calS} \boldsymbol a_i {  \bs B}_{ij} {\bs M} \bs b_j .\]
Thus, we can think of 
\[\boldsymbol \phi (x) {\bs M}^{-1}{  \bs B}_{ij} \bs \phi(y)\tr{}\wrt y,\]
as an approximation to the kernel \(\mathbb B_{ij}(x,\wrt y)\). This concept can be extended to all the approximations of operators considered in this work. 

\subsection{Approximating the operator \(\mathbb R\)}\label{sec: approx r}
Recall the operator \(\mathbb R^k\) from Lemma~\ref{lemma: D(s)}. Essentially, the operator \(\mathbb R^k\) takes an initial measure \(\boldsymbol \mu_k\) and multiplies each element by \(1/|r_i(x)|\) on cells \(\calD_k\) where \(r_i(x)\neq 0\). In the context of DG the initial distribution is given by \(\boldsymbol a_i \boldsymbol \phi(x)\tr{}\in U,\,i\in\calS\). Thus, for \(k\in\mathcal K\) such that \(r_i(x)\neq0\) on \(\calD_k\), we have 
\[\boldsymbol a_{k,i} \boldsymbol \phi_k(x)\tr{}\mathbb R^k_i = \cfrac{\boldsymbol a_{k,i} \boldsymbol \phi_k(x)\tr{}}{|r_i(x)|}.\]
Decompose the right-hand side into a component which lies in \(U\) and another orthogonal to \(U\): 
\[\cfrac{\boldsymbol a_{k,i} \boldsymbol \phi_k(x)\tr{}}{|r_i(x)|} = \bs \rho_{k,i} \bs \phi_k(x)\tr{} + g_i^\perp(x),\] where \(\bs \rho_{k,i} \bs\phi_k(x)\tr{}\in U\), \(g_i^\perp \in U^\perp\). Now, multiply by test functions \(\{\phi^r_k(x)\}_{r=1}^{p_k}\) and integrate over \([0,b]\):
\begin{align*}
	\boldsymbol a_{k,i}\int_{x\in[0,b]} \cfrac{ \boldsymbol \phi_k(x)\tr{}\bs \phi_k(x)}{|r_i(x)|}\wrt x
	&=\bs \rho_{k,i} \int_{x\in[0,b]}\bs \phi_k(x)\tr{}\bs \phi_k(x)\wrt x + \int_{x\in[0,b]} g_i^\perp(x)\bs\phi_k(x)\wrt x 
	%
	\\&= \bs \rho_{k,i} \int_{x\in[0,b]}\bs \phi_k(x)\tr{}\bs \phi_k(x)\wrt x = \bs \rho_{k,i}\bs M_k,
\end{align*}
since \(g_i(x)^\perp\in U^\perp\). Define the matrix \(\bs M_k^r = \displaystyle\int_{x\in[0,b]} \cfrac{ \boldsymbol \phi_k(x)\tr{}\bs \phi_k(x)}{|r_i(x)|}\wrt x\), then 
\(
	\boldsymbol a_{k,i}\bs M_k^r
	= \bs \rho_{k,i} \bs M_k,
\)
which implies
\(
	\bs \rho_{k,i}  = \boldsymbol a_{k,i}\bs M_k^r\bs M_k^{-1}.
\)
Thus, we have the approximation 
\[\boldsymbol a_{k,i} \boldsymbol \phi_k(x)\tr{}\mathbb R^k_i = \cfrac{\boldsymbol a_{k,i} \boldsymbol \phi_k(x)\tr{}}{|r_i(x)|}\approx \boldsymbol a_{k,i}\bs M_k^r\bs M_k^{-1}\bs\phi_k(x)\tr{}.\]
Since \(\boldsymbol a_{k,i}\) is arbitrary, we see that we approximate \(\mathbb R_{k,i}\) by \(  \bs R_{k,i} = \bs M_k^r\bs M_k^{-1},\)
and \(\mathbb R^k\) by \(  \bs R^k = \mathrm{diag}(  \bs R_{k,i},{i\in\calS^\bullet_k})\).

In practice, we implement a Gauss-Lobatto quadrature approximation to compute the elements of \(\bs M_k^r\).

\begin{rem}
	We could also use interpolation to approximate \(\mathbb R\). 
\end{rem}

\subsection{Approximating the operator \(\mathbb D\) and the Riccati equation}
Recalling Lemma~\ref{lemma: D(s)} and replacing the operators \(\mathbb R^k\) and \(\mathbb B^{\ell m}\), by their approximations we have the following approximation to \(\mathbb D^{mn}(s)\)
\begin{align*}
		 {\bs D}^{mn}(s) = \left[ \bs {R}^{m}\left(
		{ {\bs B}}^{mn} - s{\bs I} + { {\bs B}}^{m0 }\left({ {\bs B}}^{00}- s\bs I \right)^{-1} { {\bs B}}^{0n}\right)\right],\quad m,n \in\{+,-\}.
\end{align*} 

Let \(\bs\phi_k(x){\bs M}_k^{-1}\bs \Psi_{ij}^{k\ell}(s)\bs\phi_\ell(y)\tr{}\wrt y\), \(i,j\in\calS,\) \(k\in\mathcal K_i^+\,, \ell\in\mathcal K_j^-\) be a finite-dimensional approximation of the operator kernel \(\mathbb\Psi_{ij}^{k\ell}(s)(x,\wrt y)\), where \(\bs \Psi_{ij}^{k\ell}(s)\) is a matrix of constants for a given \(s\). Construct an approximation to \(\mathbb\Psi(s)(x,\wrt y)\) by 
\[\bs\phi^+(x){\bs M}_+^{-1}\bs \Psi(s)\bs\phi^-(y)\tr{}\wrt y = \bs \phi^+(x)\bs M_+ \left[\left[\bs \Psi_{ij}^{k\ell}\right]_{i\in\calS_k^+,j\in\calS_\ell^-}\right]_{k\in\mathcal K^+,\ell\in\mathcal K^-}\bs \phi^-(y)'\wrt y\]%\left[\left[\bs\phi^k(x)\bs {M}_k^{-1}\bs \Psi_{ij}^{k\ell}(s)\bs\phi^\ell(y)\tr{}\wrt y\right]_{i\in\calS_k^+,j\in\calS_\ell^-}\right]_{ k\in\mathcal K^+, \ell\in\mathcal K^-},\]
where \(\bs\phi^+(x) = (\bs\phi_k(x))_{i\in\calS_k^+,k\in\mathcal K^+}\) and \(\bs\phi^-(y) = (\bs\phi_k(y))_{i\in\calS_k^-,k\in\mathcal K^-}\) are row-vectors, \(\bs \Psi(s)\) is a matrix of constants for a given \(s\) with the same size as \(\bs D^{+-}\), and \({\bs M}_m,\) \(m\in\{+,-,0\}\) is a block diagonal matrix \({\bs M}_m = \mathrm{diag}\left(  \bs M_k, {i\in\calS_k^m}, {k\in\mathcal K^m}\right)\), \(m\in\{+,-,0\}\). Now replace the theoretical kernels in Theorem~\ref{theo:Psi} by their DG approximations to get 
\begin{align*}
&\bs\phi^+(x){\bs M}_+^{-1}  \bs D^{+-}(s)\bs\phi^-(y)\tr{}\wrt y
\\&{}+ \int_{z_1,z_2}\bs\phi^+(x){\bs M}_+^{-1}\bs \Psi(s)\bs\phi^-(z_1)\tr{}\bs\phi^-(z_1) {\bs M}_-^{-1}  \bs D^{-+}(s)\bs\phi^+(z_2)
\\&{}\quad\times\bs\phi^+(z_2){\bs M}_+^{-1}\bs \Psi(s)\bs\phi^-(y)\tr{}\wrt z_1\wrt z_2\wrt y
\\&{}+ \int_{z_1}\bs\phi^+(x){\bs M}_+^{-1}  \bs D^{++}(s)\bs\phi^+(z_1)\tr{}\bs\phi^+(z_1) {\bs M}_+^{-1}\bs \Psi(s)\bs\phi^-(y)\tr{}\wrt z_1\wrt y
\\&{}+ \int_{z_1}\bs\phi^+(x){\bs M}_+^{-1}\bs \Psi(s)\bs\phi^-(z_1)\tr{}\bs\phi^-(z_1){\bs M}_-^{-1}  \bs D^{--}(s)\bs\phi^-(y)\tr{}\wrt z_1\wrt y
= 0.
\end{align*}
Multiplying on the left by \(\bs\phi^+(x)\tr{}\) and on the right by \(\bs\phi^-(y)\), integrating over both \(x\) and \(y\), then post-multiplying by \({\bs M}^{-1}_-\) gives the matrix Riccati equation
\begin{align}\label{eqn:RiccatiPsi}
    \bs D^{+-}(s)
+ \bs \Psi(s)   \bs D^{-+}(s)\bs \Psi(s)
+   \bs D^{++}(s)\bs \Psi(s)
+ \bs \Psi(s)  \bs D^{--}(s)
= \bs 0.
\end{align}
Thus, we may find \(\bs \Psi(s)\) by solving \eqref{eqn:RiccatiPsi}, using one of the methods in \citep{bot08}. Here, we use Newtons method. 

\begin{rem}
	Given the stochastic interpretation of \(\mathbb\Psi(0)\) we know that \( \bs \mu^+ \mathbb\Psi(0)([0,\infty))=1\) for every vector of measures \( \bs \mu^+\) such that \( \bs \mu^+([0,\infty)\boldsymbol 1 = 1\), when a fluid-fluid queue is recurrent. It appears that this result carries over to the matrix \(\bs \Psi(0)\) giving the property that \(\displaystyle\int_{y\in[0,b]} \bs \Psi(0)\bs\phi^-(y)\tr{}\wrt y = \bs 1\). However, we have only observed this numerically and have no proof of this property. 
\end{rem}

\subsection{Putting it all together: constructing an approximation to the limiting distribution}
We find an approximation to the limiting distribution by replacing the theoretical operators in Theorem~\ref{theo:density} with their approximations. Table~\ref{table:notations} defines the notation we use for the DG approximations to limiting operators. 

 \begin{table}[h!]
 \centering
 \begin{tabular}{c|c|c|c}
	\begin{tabular}{c}Exact\end{tabular} & Operator indices & \begin{tabular}{c}Approximation \\ notation\end{tabular} & Approximations \\\hline 
	%
	\( \bbxi_{k,i} \) & \(i\in\calS_k^-,\,k\in\mathcal K^-\)  & \(\bs \xi_{k,i} = (\xi_{k,i}^r)_{r\in\mathcal N_k}\) & 
	\(%\begin{array}{c}
	\bbxi_{k,i}(\wrt x)\approx  \bs{\xi}_{k,i} \bs \phi^k(x)\tr{}\wrt x,
	 %\\\bbxi_i^{-1}(\{0\}) %=\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = 0, \varphi_{\theta_n} = i\right]
	%\approx \bs\xi_{i}^{-1},
	%\\\bbxi_i^{K+1}(\{b\}) %= \lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = b, \varphi_{\theta_n} = i\right]
	%\approx \bs\xi_{i}^{K+1}.%\end{array}
	\)
	 \\\hline
%
%
	\(\mathbb p_{k,i}\) & \(\begin{array}{c}i\in\calS_k^-\cup\calS_k^0,\\k\in\bigcup\limits_{m\in\{-,0\}}\mathcal K_m\end{array}\) & \(\bs p_{k,i} = (p_{k,i}^r)_{r\in\mathcal N_k}\) & \(%\begin{array}{c}
	\mathbb p_{k,i}(\wrt x) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t = 0, X_{t} \in \wrt x, \varphi_{t} = i\right]\\
	\approx\bs{p}_{k,i} \bs\phi_k(x)\tr{}\wrt x
	%\\ \mathbb p_{i}^{-1}(\{0\}) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t=0, X_{t} = 0, \varphi_{t} = i\right]
	%\approx \bs p_{i}^{-1},\\ \mathbb p_{i}^{K+1}(\{b\}) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t=0, X_{t} = b, \varphi_{t} = i\right]
	%\approx \bs p_{i}^{K+1}.% \end{array}
	\)\\\hline
%
%
	 \(\bbpi_{k,i}(y)\)  & \(\begin{array}{c}i\in\calS,\\k\in\mathcal K\end{array}\) & \(\bs \pi_{k,i}(y) = (\pi_{k,i}^r(y))_{r\in\mathcal N_k}\) & \(%\begin{array}{c}
	 \bbpi_{k,i}(y)(\wrt x) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t \in \wrt y, X_{t} \in \wrt x, \varphi_{t} = i\right]\\
	\approx\bs{\pi}_{k,i}(y) \bs \phi_k(x)\tr{}\wrt x
	%\\ \bbpi_{i}^{-1}(y)(\{0\}) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t=0, X_{t} = 0, \varphi_{t} = i\right]
	%\approx \bs \pi_{i}^{-1}(y),\\ \bbpi_{i}^{K+1}(y)(\{b\}) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t=0, X_{t} = b, \varphi_{t} = i\right]
	%\approx \bs \pi_{i}^{K+1}(y). \end{array}
	\)\\\hline
 \end{tabular}
 \caption{Notation for the approximation of the limiting operators of a fluid-fluid queue. The first column contains the operators which we are approximating, the second column contains indices for which the operators are defined, the third column defines the notation we use for the coefficients of the approximation, and the last column defines how the coefficients and basis functions are used to approximate the operators. \label{table:notations}}
 \end{table}

%  \begin{table}[h!]
% \centering
% \begin{tabular}{c|c|c|c}
%	\begin{tabular}{c}Exact \\Operator\end{tabular} & Notation & Set of indices & Approximation \\\hline 
%	%
%	\( \bbxi_{k,i}(\wrt x) \) & \(\xi_{k,i}^r\) & \(\begin{array}{l}i\in\calS,\,r\in\{1,...,N_k\},\\k\in\mathcal K_i^-\setminus \{{-1}\cup{K+1}\}.\end{array}\) & \(%= \lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} \in \wrt x, \varphi_{\theta_n} = i\right]\\
%	 \displaystyle\sum\limits_{r=1}^{N_k} {\xi}_{k,i}^r \phi^r_k(x)\wrt x,\,x\in\calD_k.\)\\\hline
%
%	&\(\xi_{k,i}^r\) & \(\begin{array}{l}i\in\calS,\,r=1,\\k\in\mathcal K_i^-\cap \{{-1}\cup{K+1}\}.\end{array}\) & \(\begin{array}{l}\bbxi_{k,i}(\{0\}) %=\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = 0, \varphi_{\theta_n} = i\right]
%	\approx \xi_{i,r}^{-1},
%	\\\bbxi_{k,i}(\{b\}) %= \lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = b, \varphi_{\theta_n} = i\right]
%	\approx \xi_{i,r}^{K+1}.\end{array}\)\\\hline 
%
%	&\(p_{k,i}^r\) & \(\begin{array}{l}i\in\calS,\,r\in\{1,...,N_k\},\\k\in\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m\setminus \{{-1}\cup{K+1}\}.\end{array}\) & \(\mathbb p_{k,i}(\wrt x) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t = 0, X_{t} \in \wrt x, \varphi_{t} = i\right]\\
%	\approx\displaystyle\sum\limits_{r=1}^{N_k} {p}_{k,i}^r \phi^r_k(x)\wrt x,\,x\in\calD_k.\)\\\hline
%
%	&\(p_{k,i}^r\) & \(\begin{array}{l}i\in\calS,\,r=1,\\k\in\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m\cap \{{-1}\cup{K+1}\}.\end{array}\) & \(\begin{array}{l} \mathbb p_{k,i}(\{0\}) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t=0, X_{t} = 0, \varphi_{t} = i\right]
%	\approx p_{i,r}^{-1},\\ \mathbb p_{k,i}(\{b\}) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t=0, X_{t} = b, \varphi_{t} = i\right]
%	\approx p_{i,r}^{K+1}. \end{array}\) \\\hline
%
%	&\(\pi_{k,i}^r(y)\) & \(\begin{array}{l}i\in\calS,\,r\in\{1,...,N_k\},\\k\in\bigcup\limits_{m\in\{+,-,0\}}\mathcal K_i^m\setminus \{{-1}\cup{K+1}\}.\end{array}\) & \(\bbpi_{k,i}(y)(\wrt x) %= \lim\limits_{t\to\infty}\mathbb{P}\left[W_t \in \wrt y, X_{t} \in \wrt x, \varphi_{t} = i\right]\\
%	\approx\displaystyle\sum\limits_{r=1}^{N_k} {\pi}_{k,i}^r(y) \phi^r_k(x)\wrt x,\,y>0,\, x\in\calD_k.\)\\\hline
% \end{tabular}
% \caption{Notation for the approximation of the limiting operators of an SFFM.\label{table:notations}}
% \end{table}
 
With the notation in Table~\ref{table:notations} define row-vectors 
 \begin{align*}
	%{\bs{\xi}}_{k,i} &= ( \xi_{k,i}^r)_{r\in\{1,...,N_k\}}, \quad  { i\in\calS,\,k\in\mathcal K_i^-},
	%
	{\bs{\xi}}_k &= ( \bs\xi_{k,i})_{i\in\calS_k^-}, \quad  {k\in\mathcal K_i^-},
	%
	\\ {\bs{\xi}}& = ( \bs \xi_k)_{k\in\mathcal K^-},
	% 
	%\\{\bs{p}}_{k,i} &= (  p_{k,i}^r)_{r\in\{1,...,N_k\}}, \quad  {i\in\calS,\,k\in\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m},
	%
	\\\bs{p}^{m}_k &= (  \bs p_{k,i})_{i\in\calS_k^m}, \quad  k\in{\mathcal K^m},\, m\in\{-,0\},
	%
	\\ {\bs{p}^m} &= (  \bs p^{m}_k)_{k\in\mathcal K^m},\quad m\in\{-,0\},
	%
	\\ {\bs{p}} &= (  \bs p^m)_{m\in\{-,0\}},
	%
	%\\{\bs{\pi}}_{k,i}(y) &= (  \pi_{k,i}^r(y))_{r\in\{1,...,N_k\}},\quad  i\in\calS,\,k\in\bigcup\limits_{m\in\{+,-,0\}}\mathcal K_i^m,
	%
	\\{\bs{\pi}}^{k}_m(y) &= (  \bs \pi_{k,i}(y))_{i\in\calS_k^m},\quad  k\in\mathcal K,\,m\in\{+,-,0\},
	%
	\\{\bs{\pi}}^m(y) &= (\bs \pi^{k}_m(y))_{k\in\mathcal K^m},\quad  m\in\{+,-,0\},
	%
	\\ {\bs{\pi}}(y) &= (  \bs \pi^m(y))_{m\in\{+,-,0\}}.
 \end{align*}
 
Proceeding similarly to the derivation of the Riccati equation~(\ref{eqn:RiccatiPsi}), we can argue that the coefficients \( {\boldsymbol{\xi}}\) are the solution to the matrix system 
% 	 
	\begin{align*}
		\vligne{ {\boldsymbol{\xi}}  & \boldsymbol{0}}\left(-\left[\begin{array}{ll} 
			 { {\bs B}}^{--} &  { {\bs B}}^{-0} \\
                         { {\bs B}}^{0-} &  { {\bs B}}^{00} 
		\end{array} \right]\right)^{-1}\left[\begin{array}{l} 
			 { {\bs B}}^{-+} \\ 
			 { {\bs B}}^{0+}
		\end{array} \right]\bs \Psi(0) & =  {\boldsymbol{\xi}}, \\ 
		\int_{x\in[0,b]} {\bs \xi}\left[\begin{array}{c}\bs \phi^-(x)\tr{} \\ \bs \phi^0(x)\tr{}\end{array}\right]\wrt x \boldsymbol 1 & = 1. 
	\end{align*} 
Essentially, we replace the theoretical operators in (\ref{eqn:xi1}) and (\ref{eqn:xi2}) with their DG counterparts. 

Similarly, the coefficients \( {\boldsymbol{p}}\) are given by 
	\begin{equation}\vligne{\bs{p}^{-}  & \bs{p}^{0}} = Z \vligne{{\bs\xi} & \bs{0}} 
	\left(-\left[\begin{array}{ll} 
		{\bs B}^{--} & {\bs B}^{-0} \\
		{\bs B}^{0-} & {\bs B}^{00} 
		\end{array} \right] \right)^{-1},\label{eqn:pisystem1}\end{equation}
		where \(Z\) is a normalising constant. The coefficients \(\bs \pi(y)\) are given by 
\begin{align} 
	\;  {\bs{\pi}}^{0}(y) &= \vligne{ {\bs{\pi}}^{+}(y) &  {\bs{\pi}}^{-}(y)}\left[\begin{array}{l} { {\bs B}}^{+0} \\ { {\bs B}}^{-0} \end{array} \right]\left(-{ {\bs B}}^{00}\right)^{-1}, \\ 
	% 
	 \vligne{ {\bs{\pi}}^{+}(y) &  {\bs{\pi}}^{-}(y)}& = \vligne{ {\bs{p}}^{-} &  {\bs{p}}^{0}}\left[\begin{array}{l} { {\bs B}}^{-+} \\ { {\bs B}}^{0+} \end{array} \right]\vligne{e^{ {\bs K}y} & e^{ {\bs K}y}\bs \Psi(0)}\left[\begin{array}{cc}  {\bs R}^{+} & 0 \\ 0 &  {\bs R}^{-}\end{array}\right], \\
	%  
	 \sum_{i \in \mathcal{S}}\sum_{k \in \mathcal K} & \int_{y = 0}^{\infty} \int_{x \in [0,b]}  \bs \pi_{k,i}(y)\bs\phi_k(x)\tr{}\wrt x\wrt y 
	 %
	 \\&{}+  \sum_{i \in \mathcal{S}}\sum_{\ell \in \{-,0\}}\sum_{k\in \mathcal K_i^\ell}  \int_{x \in [0,b]}  \bs p_{k,i}\bs\phi_k(x)\tr{}\wrt x = 1,\label{eqn:pisystem2}
	\end{align}
	% 
	where $ {\bs K} =  {\bs D}^{++}(0) + \bs \Psi(0) {\bs D}^{(-+)}(0)$, and $z$ is a normalising constant.

%For \(i,k,r\) such that \(i\in\calS,\,r\in\{1,...,N_k\},\,k\in\mathcal K_i^-\setminus \{{-1}\cup{K+1}\}\), define coefficients \(  \xi_{k,i}^r\) to be determined later such that 
%\[\displaystyle\sum\limits_{r\in\{1,...,N_k\}} {\xi}_{k,i}^r \phi^r_k(x),\quad x \in \calD_k,\]
%is an approximation to the density of \(\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} \in \wrt x, \varphi_{\theta_n} = i\right]\) on \(x\in\calD_k\). For \(i,k,r\) such that \(i\in\calS,\,r=1,\,k\in\mathcal K_i^-\cap \{{-1}\cup{K+1}\},\) define point masses \(  \xi_{k,i}^r\) such that \( \xi_{i,r}^{-1}\) and \( \xi_{i,r}^{K+1}\) approximate the point masses \(\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = 0, \varphi_{\theta_n} = i\right]\) and \(\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = b, \varphi_{\theta_n} = i\right]\), respectively. In vector form, for \(i,k\) such that \(i\in\calS,\,k\in\mathcal K_i^-\), let \( {\bs{\xi}}_{k,i} = ( \xi_{k,i}^r)_{r\in\{1,...,N_k\}}\), for \(k\in\bigcup\limits_{i\in\calS}\mathcal K_i^-\), let \( {\bs{\xi}}^k = ( \xi_{k,i})_{\{i\in\calS\mid r_i(x)<0,x\in\calD_k\}}\) and let \( {\bs{\xi}} = ( \xi^k)_{k\in\bigcup\limits_{i\in\calS}\mathcal K_i^-}\). 
%
%Proceeding similarly to the derivation of the Riccati equation~(\ref{eqn:RiccatiPsi}), we can argue that the DG approximation to \( {\boldsymbol{\xi}}\) is the solution to the matrix system 
%% 	 
%	\begin{align}
%		\vligne{ {\boldsymbol{\xi}}  & \boldsymbol{0}}\left(-\left[\begin{array}{ll} 
%			 { {B}}^{--} &  { {B}}^{-0} \\
%                         { {B}}^{0-} &  { {B}}^{00} 
%		\end{array} \right]\right)^{-1}\left[\begin{array}{l} \label{eqn:xi1}
%			 { {B}}^{-+} \\ 
%			 { {B}}^{0+}
%		\end{array} \right]\Psi(0) & =  {\boldsymbol{\xi}}, \\ 
%		\int_y  {\bs \xi}\left[\begin{array}{c}\bs \phi^-(x)\tr{} \\ \bs \phi^0(x)\tr{}\end{array}\right]\wrt x \boldsymbol 1 & = 1. \label{eqn:xi2}
%	\end{align} 
%Essentially, we replace the theoretical operators in (\ref{eqn:xi1}) and (\ref{eqn:xi2}) with their DG counterparts. 
%%	We write 
%%	\( {\bs\xi} = \vligne{ {\bs\xi}_{-1} &  {\bs\xi}^\circ &  {\bs\xi}_{K+1}}\), where \( {\bs\xi}_{-1}=( {\xi}_{{-1},i})_{\{\i\in\calS_{-1}\mid r_i(0)<0\}}\) and \( {\bs\xi}_{K+1}=( {\xi}_{{K+1},i})_{\{\i\in\calS_{K+1}\mid r_i(0)<0\}}\) are associated with the boundaries at \(0\) and \(b\), respectively, and \( {\bs\xi}^\circ\) is associated with the interior \(x\in(0,b)\). Let us denote the elements of \( {\bs{\xi}}^\circ\) as \( {\xi}_{k,i}^r\), \(i\in\calS,\,r\in\{1,...,N_k\},\,k\in\mathcal K_i^-\) where the elements are ordered by \(k\) then \(i\) and then \(r\).
%%	We construct an approximation to the density of \(\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} \in \wrt x, \varphi_{\theta_n} = i\right]\) as \(\displaystyle\sum\limits_{\substack{k\in\mathcal K_i^- \\r\in\{1,...,N_k\}}} {\xi}_{k,i}^r \phi^r_k(x)\). An approximation to \(\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = 0, \varphi_{\theta_n} = i\right]\) is \( {\xi}_{{-1},i}\) and an approximation to the artificial point mass \(\lim\limits_{n\to\infty}\mathbb{P}\left[X_{\theta_n} = b, \varphi_{\theta_n} = i\right]\) is \( {\xi}_{{K+1},i}\).
%	
%	Next, we seek to approximate the limiting operators \(\bs p\) defined in (\ref{eqn:jointmass}). For \(i,k,r\) such that \(i\in\calS,\,r\in\{1,...,N_k\},\,k\in\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m\setminus \{{-1}\cup{K+1}\}\), coefficients \(p_{k,i}^r\) to be determined later, such that 
%\[\displaystyle\sum\limits_{r\in\{1,...,N_k\}}p_{k,i}^r \phi^r_k(x),\quad x \in \calD_k,\]
%is an approximation to the density of \(\lim\limits_{t\to\infty}\mathbb{P}\left[W_t = 0, X_{t} \in \wrt x, \varphi_{t} = i\right]\) on \(x\in\calD_k\). For \(i,k,r\) such that \(i\in\calS,\,r=1,\,k\in\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m\cap \{{-1}\cup{K+1}\},\) define point masses \(p_{k,i}^r\) such that \(p_{i,r}^{-1}\) and \(p_{i,r}^{K+1}\) approximate the point masses \(\lim\limits_{t\to\infty}\mathbb{P}\left[W_t=0, X_{t} = 0, \varphi_{t} = i\right]\) and \(\lim\limits_{t\to\infty}\mathbb{P}\left[W_t = 0, X_{t} = b, \varphi_{t} = i\right]\), respectively. In vector form, for \(i,k\) such that \(i\in\calS,\,k\in\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m\), let \( {\bs{p}}_{k,i} = (  p_{k,i}^r)_{r\in\{1,...,N_k\}}\), for \(k\in\bigcup\limits_{i\in\calS}\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m\), let \( {\bs{p}}^k = (  p_{k,i})_{\{i\in\calS\mid r_i(x)\leq 0,x\in\calD_k\}}\) and let \( {\bs{p}} = (  p^k)_{k\in\bigcup\limits_{i\in\calS}\bigcup\limits_{m\in\{-,0\}}\mathcal K_i^m}\). Again, by proceeding similarly to the derivation of (\ref{eqn:RiccatiPsi}), that the DG approximation to \( {\boldsymbol{p}}\) is 
%	\[\vligne{\bs{p}^{-}  & \bs{p}^{0}} = z \vligne{{\bbxi} & \bs{0}} 
%	\left(-\left[\begin{array}{ll} 
%		{B}^{--} & {B}^{-0} \\
%		{B}^{0-} & {B}^{00} 
%		\end{array} \right] \right)^{-1},\]
%		where \(z\) is a normalising constant. 
%That is, we substitute the DG approximations of the operators into the corresponding equation in Theorem~\ref{theo:density}.
%%	
%%	For \(i\in\calS_{-1}, m\in\{-,0\}\) define \(  p^m_{{-1},i}\) as the approximation to \( \lim\limits_{t\to\infty}\mathbb{P}\left[X_{t} =0, W_t=0, \varphi_{t} = i\right]\).
%%	
%%	 \( {\bs p}^-_{{-1}}=(  p^-_{{-1},i})_{\{i\in\calS_{-1}\mid r_i(0)<0\}}\) and \( {\bs p}^0_{{-1}}=(  p^0_{{-1},i})_{\{i\in\calS_{-1}\mid r_i(0)=0\}}\). 
%%	Now define \( {\bs p}^m_{{-1}},\, {\bs p}^m_{\circ},\, {\bs p}^m_{{K+1}}\) as the approximation to \(\bs p\) at the left-hand boundary, interior, and on the right-hand boundary of \([0,b]\), respectively.
%%	\[ {\bs p}^m = \vligne{ {\bs p}^m_{-1}(y) &  {\bs p}^m_\circ(y) &  {\bs p}^m_{K+1}(y)},\quad m\in\{-,0\},\]
%%where Specifically,  
%
%	
%	Next we approximate the operator \({{\bbpi}}(y)\). For \(i,k,r\) such that \(i\in\calS,\,r\in\{1,...,N_k\},\,k\in\bigcup\limits_{m\in\{+,-,0\}}\mathcal K_i^m\setminus \{{-1}\cup{K+1}\}\), define \(\pi_{k,i}^r(y)\), to be determined later, such that 
%\[\displaystyle\sum\limits_{r\in\{1,...,N_k\}}\pi_{k,i}^r(y) \phi^r_k(x),\quad x \in \calD_k,\]
%is an approximation to the density of \(\lim\limits_{t\to\infty}\mathbb{P}\left[W_t \in\wrt y, X_{t} \in \wrt x, \varphi_{t} = i\right]\) on \(x\in\calD_k\). For \(i,k,r\) such that \(i\in\calS,\,r=1,\,k\in\bigcup\limits_{m\in\{+,-,0\}}\mathcal K_i^m\cap \{{-1}\cup{K+1}\}\) define point masses \(\pi_{k,i}^r(y)\) such that \(\pi_{i,r}^{-1}(y)\) and \(\pi_{i,r}^{K+1}(y)\) approximate the point masses \(\lim\limits_{t\to\infty}\mathbb{P}\left[W_t\in\wrt y, X_{t} = 0, \varphi_{t} = i\right]\) and \(\lim\limits_{t\to\infty}\mathbb{P}\left[W_t \in\wrt y, X_{t} = b, \varphi_{t} = i\right]\), respectively. In vector form, for \(i,k\) such that \(i\in\calS,\,k\in\bigcup\limits_{m\in\{+,-,0\}}\mathcal K_i^m\), let \( {\bs{\pi}}_{k,i}(y) = (  \pi_{k,i}^r(y))_{r\in\{1,...,N_k\}}\), for \(k\in\bigcup\limits_{i\in\calS}\bigcup\limits_{m\in\{+,-,0\}}\mathcal K_i^m\), let \( {\bs{\pi}}^k(y) = (  \pi_{k,i}(y))_{\{i\in\calS\mid r_i(x)\leq 0,x\in\calD_k\}}\) and let \( {\bs{\pi}}(y) = (  \pi^k(y))_{k\in\bigcup\limits_{i\in\calS}\bigcup\limits_{m\in\{+,-,0\}}\mathcal K_i^m}\). Again, we can argue that the DG approximation to \( {\boldsymbol{\pi}}(y)\) is given by substituting the DG operators for their theoretical counterparts in Theorem~\ref{theo:density}
%	\begin{align} 
%	& \;  {\bs{\pi}}^{0}(y) = \vligne{ {\bs{\pi}}^{+}(y) &  {\bs{\pi}}^{-}(y)}\left[\begin{array}{l} { {B}}^{+0} \\ { {B}}^{-0} \end{array} \right]\left(-{ {B}}^{00}\right)^{-1}, \label{eqn:pisystem1} \\ 
%	% 
%	&  \vligne{ {\bs{\pi}}^{+}(y) &  {\bs{\pi}}^{-}(y)} = \vligne{ {\bs{p}}^{-} &  {\bs{p}}^{0}}\left[\begin{array}{l} { {B}}^{-+} \\ { {B}}^{0+} \end{array} \right]\vligne{e^{ {K}y} & e^{ {K}y}\Psi(0)}\left[\begin{array}{cc}  {R}^{+} & 0 \\ 0 &  {R}^{-}\end{array}\right], \\
%	%  
%	 &\sum_{r \in \{{-1},1,...,K,{K+1}\}}\sum_{i \in \mathcal{S}_{\ell}} \int_{y = 0}^{\infty}  \pi_{i,r}^{k}(y)\phi_{k}^r(x)\wrt x\wrt y + \sum_{\ell \in \{-,0\}} \sum_{i \in \mathcal{S}}\sum_{r\in \mathcal K_i^\ell}   p^{r}_i(\mathcal{F}^{\ell}_i) = 1,\label{eqn:pisystemend}
%	\end{align}
%	% 
%	where $ {K} =  {D}^{++}(0) + \Psi(0) {D}^{(-+)}(0)$, and $z$ is a normalising constant.
%	%
%%Also \( {\bs p}^-_{{K+1}}=(  p^-_{{K+1},i})_{\{i\in\calS_{K+1}\mid r_i(b)<0\}}\) and \( {\bs p}^0_{{K+1}}=(  p^0_{{K+1},i})_{\{i\in\calS_{K+1}\mid r_i(b)=0\}}\) where \(  p^m_{{K+1},i},\,m\in\{-,0\}\) are approximations to \( \lim\limits_{t\to\infty}\mathbb{P}\left[X_{t} =b, W_t=0, \varphi_{t} = i\right]\). On the interior, we have 
%%\( {\bs p}^m_{\circ}=( {\bs p}_{k,i})_{i\in\calS,k\in\mathcal K_i^m}\) where \( {\bs p}_{k,i}=( {p}_{k,i}^r)_{r=1,...,N_k}\). On \(\mathcal D_k\) an approximation to the density of \(\lim\limits_{t\to\infty}\mathbb{P}\left[X_{t} =\wrt x, W_t=0, \varphi_{t} = i\right]\) is given by \( {\bs p}_{k,i}\bs \phi^k(x)\tr{}\).
%%
%%Similarly for \( {\bs\pi}\) we write \[ {\bs \pi}^m =\vligne{ {\bs \pi}^m_{-1}(y) &  {\bs \pi}^m_\circ(y) &  {\bs \pi}^m_{K+1}(y)},\quad m\in\{+,-,0\},\]
%%where \( {\bs \pi}^m_{{-1}}(y),\, {\bs \pi}^m_{\circ}(y),\, {\bs \pi}^m_{{K+1}}(y)\) correspond to the approximation at the left-boundary, interior, and on the right boundary of \(x\in[0,b]\), respectively. 
%%%
%%Specifically, \( {\bs \pi}^+_{{-1}}(y)=(  \pi^+_{{-1},i}(y))_{\{i\in\calS_{-1}\mid r_i(0)>0\}}\), \( {\bs \pi}^-_{{-1}}(y)=(  \pi^-_{{-1},i}(y))_{\{i\in\calS_{-1}\mid r_i(0)<0\}}\) and \( {\bs \pi}^0_{{-1}}(y)=(  \pi^0_{{-1},i}(y))_{\{i\in\calS_{-1}\mid r_i(0)=0\}}\) where \(  \pi^m_{{-1},i}(y),\,m\in\{+,-,0\}\) are approximations to \( \lim\limits_{t\to\infty}\mathbb{P}\left[X_{t} =0, W_t=\wrt y, \varphi_{t} = i\right]\). 
%%%
%%Also \( {\bs \pi}^+_{{K+1}}(y)=(  \pi^+_{{K+1},i}(y))_{\{i\in\calS_{K+1}\mid r_i(b)>0\}}\), \( {\bs \pi}^-_{{K+1}}(y)=(  \pi^-_{{K+1},i}(y))_{\{i\in\calS_{K+1}\mid r_i(b)<0\}}\) and \( {\bs \pi}^0_{{K+1}}(y)=(  \pi^0_{{K+1},i}(y))_{\{i\in\calS_{K+1}\mid r_i(b)=0\}}\) where \(  \pi^m_{{K+1},i}(y),\,m\in\{+,-,0\}\) are approximations to \( \lim\limits_{t\to\infty}\mathbb{P}\left[X_{t} =b, W_t\in\wrt y, \varphi_{t} = i\right]\). 
%%%
%%On the interior, we have 
%%\( {\bs \pi}^m_{\circ}(y)=( {\bs \pi}_{k,i}(y))_{i\in\calS,k\in\mathcal K_i^m}\) where \( {\bs \pi}_{k,i}(y)=( {\pi}_{k,i}^r(y))_{r=1,...,N_k}\). On \(\mathcal D_k\) an approximation to the density of \(\lim\limits_{t\to\infty}\mathbb{P}\left[X_{t} =\wrt x, W_t\in\wrt y, \varphi_{t} = i\right]\) is given by \( {\bs \pi}_{k,i}(y)\bs \phi^k(x)\tr{}\).

To assist the reader in understanding these constructions and the notation we provide an explicitly worked toy-example in Appendix~\ref{appendix:example}.

% \section{A stochastic interpretation of the simplest DG scheme}
% links between DG and the uniformisation scheme
% positivity preservation
% stochastic interpretations
% how I use/analyse it in the numerics section

\section{Other problems we can solve with cell-based approximation schemes}\label{sec: other applications}
The utility of the DG scheme (or any of the approximation schemes considered in this thesis, for that matter) for fluid queues is not limited to approximating the first return and limiting operators of fluid-fluid queues. For example, we can use a DG scheme to approximate the transient distribution of the fluid queue at time \(t\), which requires us to find the coefficients \(\vligne{\bs q_{-1}(t) & \bs a(t) & \bs q_{{K+1}}(t)}\), given an initial condition, typically by numerically integrating (\ref{eqn: DG ODE w BCs}). An approximation to the limiting distribution of the fluid queue can be found by solving 
\begin{align*}
	\bs b \bs B &= \bs 0,
	\\ \bs b \bs 1 &= \bs 1,
\end{align*}
for the coefficients \(\bs b\). We can also approximate first hitting times. For example, given an initial condition on cell \(k\), we first find the initial coefficients \(\bs a_k(0)\), then approximate the probability that the level process first hits \(\{y_k,y_{k+1}\}\) after time \(t_0\) by finding \(\bs a_k(0)e^{B^{kk} t_0}\int_{y_k}^{y_{k+1}}\bs \phi_k(x)\wrt x\) where the coefficients \(\bs a_k(t_0)\) can be found by integrating the differential equation 
\[\cfrac{\wrt}{\wrt t}\bs a_k(t)=\bs a_k(t)\bs B^{kk},\]
over time. 

Indeed, the DG scheme has the potential to answer many mathematical questions for fluid queues. However, one reason DG schemes may not have found such widespread use in the context of fluid queues is the difficulties surrounding discontinuous solutions, which is something we often want to consider. Moreover, there are sometimes other techniques which can give exact solutions, for example exact expressions for transient quantities are derived in \cite{rs2003,ar2004,bean2005,bean2009}, and for the limiting distribution are derived in \cite{ajr2005,dasilva2005,lnp13,s2017}. Nonetheless, the DG scheme can be used to answer a very broad range of questions about fluid queues (such as transient distributions, hitting times on complex geometries, and of course analysis of fluid-fluid queues) which have no exact, readily computable solution.% Moreover, we will numerically investigate the performance of the DG scheme (and other numerical schemes which we will develop) in Chapter~\ref{sec: numerics} which require numerical integration with respect to time. Hence, we now briefly introduce the numerical time integration scheme which we use in this thesis, as well as some issues pertaining to oscillatory approximations. 

% APPLICATION TO INTERGRATING OVER TIME
% \section{Remarks on slope limiters, linear operators and application to fluid-fluid queues}\label{sec: limiting and linearity}
% The process of slope limiting, as described in Section~\ref{sec: slope limiting}, essentially amounts to a non-linear post-processing of the approximate solution after applying the operator \(\bs B\). Thus, the slope-limited scheme arrives at an approximation which is the action of a non-linear operator applied to the initial condition. The fact that the approximate operator is non-linear makes solving the Riccati Equation~(\ref{eqn:RiccatiPsi}) difficult/impossible, whereas there are efficient techniques to solve matrix-Riccati equations \cite{bot08}. Thus, for the application to fluid-fluid queues, slope limiting is not a viable option. %We could, however, proceed with a vanilla DG scheme (with no limiter) and, when we apply the operator \(\bs \Psi\) to some initial condition and realise an approximation to the distribution of the fluid queue when \(\{W(t)\}\) first returns to its initial level, we could then post-process the solution with a limiter or filter if oscillations are present in the approximation. The application of the limiter/filter is dependent on the initial condition, so the post-processing needs to be done for every initial condition under consideration. If there are many initial distributions to consider, this could result in an increased computational cost. We do not investigate this post-processing approach in this thesis. 

% On a related note, a linear-operator can also be useful if we want to approximate transient distributions of fluid queues for many initial conditions. For example, consider solving (\ref{eqn: DG ODE w BCs 3}) numerically with a forward-Euler scheme to integrate over time. To advance the coefficients from time \(t\) to time \(t+h\) we compute
% \begin{align*}
% 	&\bs a(t+h) = \bs a(t) + h \bs a(t)\bs Q = \bs a(t)\left[\bs I + h\bs Q\right].
% \end{align*} 
% Thus, the coefficients at time \(t_0=nh\) are given by 
% \begin{align*}
% 	&\bs a(nh) = \bs a(0)\left[\bs I + h\bs Q\right]^n,
% \end{align*} 
% which is a linear transformation of the coefficients \(\bs a(0)\). Thus, if we determine the matrix \(\left[\bs I + h\bs Q\right]^n\), then we may apply it to any initial condition to approximate the solution at time \(t_0=nh\). In the presence of a limiter, this is not possible as the coefficients at time \(t_0=nh\) are not a linear transformation of the initial coefficients. 

% Another point to note is that limiters incur a computational cost. There is a computational cost in reducing the solution to linear when oscillations are detected, and also in determining whether there are oscillations or not. Thus, even if the solution needs no limiting, there is an added computational cost in determining this is the case. Given the limiter is applied for each stage and each time-step of the time integration scheme in Section~\ref{subsec: slope lim and int}, then this computational cost may not be insignificant. 

% One advantage of the QBD-RAP (and uniformisation) scheme we develop in this thesis is that the resulting operator is positivity-preserving and linear.
% This raises two points. First, the concept of limiting applies only to problems with the concept of an approximate solution, and not to problems where the object of interest is the approximate operator itself. For example, we solve the Ricatti equation~\ref{eqn:RiccatiPsi} for the matrix \(\bs \Psi\) to find an approximation to \(\mathbb \Psi\). There is no concept of an approximate solution in this problem, only the concepts of the approximate operators. Thus, there is no concept of slope limiting
% 
% added computational cost when lots of limiting is needed
% 
